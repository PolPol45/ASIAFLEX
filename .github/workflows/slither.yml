name: "Slither static analysis"
on:
  pull_request:
  push:
    branches: [ main ]
jobs:
  slither:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
      - name: Install npm dependencies
        run: npm install
      - name: Install Slither and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install slither-analyzer
          # Download solc static binary directly from official releases (needed by Slither)
          # Using version 0.8.28 to match the project's Solidity version
          wget -O solc https://github.com/ethereum/solidity/releases/download/v0.8.28/solc-static-linux
          chmod +x solc
          sudo mv solc /usr/local/bin/
          # Remove solc-select wrapper if it exists to avoid conflicts
          rm -f ~/.local/bin/solc
          solc --version
      - name: Run slither
        run: |
          # Run slither on the project - it will auto-detect Hardhat configuration
          # Use '|| true' to prevent workflow failure if compilation has issues (e.g., network problems)
          slither . --json slither-report.json || true
          # If the above fails, try running on contracts directly
          if [ ! -f slither-report.json ]; then
            echo "Hardhat compilation failed, trying direct contract analysis..."
            slither contracts/ --json slither-report.json || echo "Direct contract analysis also failed"
          fi
      - name: Upload slither report
        uses: actions/upload-artifact@v4
        with:
          name: slither-report
          path: slither-report.json